<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <title>Stock Watchlist</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body>
    <div id="page-background">

        <!-- Initial centered view -->
        <div id="initial-view" class="centered-view expanded">
            <h1>Stock Watchlist</h1>

            <div class="search-container">
                <div class="input-wrapper">
                    <input id="search" type="text" style = "width: 210px" oninput="searchTicker()" placeholder="Search by name or symbol"
                        autocomplete="off" />
   
                    <div id="suggestions"></div>
                                     
                </div>
                <input id="raw-ticker-input" type="text" style = "width: 5px" placeholder="LNR.TO"
                        onkeydown="if(event.key === 'Enter') evaluateRawTicker()" autocomplete="off" />
                <input type="file" id="excel-import" accept=".xlsx" style="display:none"
                    onchange="importFromExcel(event)" />

                <button onclick="document.getElementById('excel-import').click()" style="margin-top: 10px;">
                    <svg viewBox="0 0 24 24" width="12" height="12">
                        <path d="M8 11h-6v10h20v-10h-6v-2h8v14h-24v-14h8v2zm-1-4l5-6 5 6h-4v11h-2v-11h-4z" />
                    </svg>
                    Import
                </button>

                <button id="export-btn" onclick="exportToExcel()" style="margin-top: 10px; display: none;">
                    <svg viewBox="0 0 24 24" width="12" height="12">
                        <path d="M8 11h-6v10h20v-10h-6v-2h8v14h-24v-14h8v2zm5 2h4l-5 6-5-6h4v-12h2v12z" />
                    </svg>
                    Export
                </button>
            </div>

            <div id="quote-container"></div>
        </div>

        <!-- Watchlist / Results view -->
        <div id="results-view" style="display: none;">
            <h2 style="display: inline-block;">My Watchlist</h2>

            <div id="watchlist">
                <table id="watchlist-table">
                    <thead>
                        <tr>
                            <th title="Ticker symbol">Symbol</th>
                            <th title="Company name and country">
                                Company
                                <span class="sort-arrows">
                                    <span onclick="sortTable('company', true)">▲</span>
                                    <span onclick="sortTable('company', false)">▼</span>
                                </span><br>
                                <small>Country</small>
                            </th>
                            <th title="Current stock price">Price</th>
                            <th title="Annual dividends as a percent of price">Dividend Yield</th>
                            <th title="Price to earnings ratio">P/E Ratio</th>
                            <th title="Return on Capital Employed">ROCE</th>
                            <th title="Measures the ability to cover interest; 10x suggests a more controlled financial position">Interest Coverage</th>
                            <th title="Gross profit as a percent of revenue">Gross Margin</th>
                            <th title="Net income as a percent of revenue">Net Margin</th>
                            <th title="Free cash flow divided by net income">Cash Conversion Ratio (FCF)</th>
                            <th title="Gross profit relative to total assets">Gross Profit / Assets</th>
                            <th style="min-width: 100px;" title="Composite financial score 0-100">
                                <div style="display: flex; align-items: center; gap: 8px; justify-content: center; padding-right: 20px">
                                    Score
                                    <span class="sort-arrows">
                                        <span onclick="sortTable('score', false)">▲</span>
                                        <span onclick="sortTable('score', true)">▼</span>
                                    </span>
                                    <button id="settings-btn" onclick="openWeightModal()" title="Adjust scoring weights" style="margin: 0; padding: 2px 8px;">
                                    ⚙
                                    </button>
                                </div>
                            </th>

                            <th title="Qualitative insights generated by AI">
                                AI Analysis<br>
                                <button onclick="runAllAI()">Run All</button>
                            </th>
                            <th title="Remove row">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="watchlist-body"></tbody>
                </table>
            </div>

            <div id="result" style="margin-top: 20px;"></div>
        </div>

        <!-- Modal container -->
        <div id="ai-modal" class="modal-overlay">
            <div id="ai-modal-content" class="modal-content">
                <button class="modal-close" onclick="closeModal()">✖</button>
                <div id="modal-content"></div>
            </div>
        </div>

        <!-- Scoring weight modal -->
        <div id="weight-modal" class="modal-overlay">
            <div id="weight-modal-content" class="modal-content">
                <div id="weight-header-content">
                    <button class="modal-close" onclick="closeWeightModal()">✖</button>
                    <h3>Adjust Scoring Weights</h3>
                </div>
                <div class="weight-inputs">
                    <label>ROCE <input type="number" id="weight-roce" oninput="updateWeightTotal()"></label>
                    <label>Interest Coverage <input type="number" id="weight-interest" oninput="updateWeightTotal()"></label>
                    <label>Gross Margin <input type="number" id="weight-gross" oninput="updateWeightTotal()"></label>
                    <label>Net Margin <input type="number" id="weight-net" oninput="updateWeightTotal()"></label>
                    <label>Cash Conversion Ratio <input type="number" id="weight-ccr" oninput="updateWeightTotal()"></label>
                    <label>Gross Profit / Assets <input type="number" id="weight-gp" oninput="updateWeightTotal()"></label>
                </div>
                <div id="weight-chart-container">
                    <div id="weight-chart">
                        <div class="weight-label">Weight</div>
                        <svg viewBox="0 0 100 100">
                            <circle class="bg" cx="50" cy="30" r="25"/>
                            <circle class="progress green" cx="50" cy="30" r="25"/>
                            <text id="weight-chart-text"
                                x="50" y="30"
                                text-anchor="middle"
                                dominant-baseline="middle"
                            >87</text>
                        </svg>
                    </div>
                    <button onclick="saveWeights()">
                        <svg viewBox="0 0 24 24" width="12" height="12">
                            <path d="M17 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zM12 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm2-10H6V5h8v4z"/>
                        </svg>
                        Save
                    </button>
                </div>

                
            </div>

    </div>

    <div id="toast"></div>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>